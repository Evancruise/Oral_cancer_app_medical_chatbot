
<div id="record-container">
    <form method="POST" enctype="multipart/form-data" action="/api/auth/export_data" class="modal-content" id="search_form">
        <div class="search-bar">
            <div class="filters">
                <div class="field">
                    <label>上傳日期</label>
                    <input class="input" type="text" id="dateRange" placeholder="2024/06/24-2024/09/24" value="<%= today_date %>~<%= today_date %>"/>
                </div>

                <div class="field">
                    <label>上傳帳號</label>
                    <select id="uploader">
                        <option value="all">全部</option>
                    </select>
                </div>
                
                <div class="field">
                    <label>分析狀態</label>
                    <select id="status">
                        <option value="all">全部</option>
                        <option value="completed">已完成</option>
                        <option value="running">未完成</option>
                        <option value="not_started">未開始</option>
                    </select>
                </div>

                <div class="field">
                    <label>辨識分類結果標籤</label>
                    <select id="category">
                        <option value="all">全部</option>
                        <option value="none">健康無病灶</option>
                        <option value="green">綠燈 (輕微等級)</option>
                        <option value="yellow">黃燈 (疑似嚴重等級)</option>
                        <option value="red">紅燈 (嚴重等級)</option>
                    </select>
                </div>

                <div class="btn-row">
                    <!-- <button type="button" class="btn btn-warning">匯入</button> -->
                    <button type="button" class="btn btn-primary" id="btn-search">查詢</button>
                    <!-- <button type="submit" id="export_data" name="action" value="export" class="btn btn-danger">匯出</button> -->
                </div>
            </div>
        </div>

        <div class="table-record-wrap">
            <table id="dataTable" aria-label="上傳紀錄表格">
                <thead>
                <tr>
                    <th style="width:14%">影像案例編號</th>
                    <th style="width:14%">建立日期</th>
                    <th style="width:14%">上傳日期</th>
                    <th style="width:14%">上傳人員</th>
                    <th style="width:14%">分析狀態</th>
                    <th style="width:14%">備註</th>
                    <th></th>
                </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </form>
</div>

<div class="pagination" id="pagination"></div>

<div class="center-btn">
    <a href="/api/auth/dashboard" class="btn-return"> <%= t("return") %> </a>
</div>

<script id="rows-data" type="application/json">
  <%- JSON.stringify(grouped_records) %>
</script>

<div class="modal fade" id="viewAllRecordModal" tabindex="-1" aria-labelledby="viewAllRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" class="card p-4" id="all_record_form">
                <div class="modal-header custom-modal-header">
                    <h5 class="modal-title animated-title" id="viewAllRecordModalLabel">
                        <i class="fas fa-edit fa-beat"></i> 查看病歷紀錄
                    </h5>
                </div>

                <div class="section-toggle styled-toggle" data-bs-toggle="collapse" data-bs-target="#basicInfoCollapse"
                role="button" aria-expanded="true" aria-controls="basicInfoCollapse">
                    <h5 class="toggle-title">
                        <i class="fas fa-chevron-down me-2 rotate-icon" data-target="#basicInfoCollapse"></i> <%= t("record.basic_info") %>
                    </h5>
                </div>

                <input type="hidden" name="token" id="token" value="<%= token %>">

                <div id="basicInfoCollapse" class="collapse show">
                    <div class="modal-body">
                        <div class="form-inline mb-3">
                            <label class="form-label">影像案例編號</label>
                            <input name="f_case" class="form-control" readonly>
                        </div>
                        <div class="form-inline mb-3">
                            <label class="form-label">建立日期</label>
                            <input name="f_createtime" class="form-control" readonly>
                        </div>
                        <div class="form-inline mb-3">
                            <label class="form-label">上傳日期</label>
                            <input name="f_uploadtime" class="form-control" readonly>
                        </div>
                        <div class="form-inline mb-3">
                            <label class="form-label">上傳人員</label>
                            <input name="f_user" class="form-control" readonly>
                        </div>
                        <div class="form-inline mb-3">
                            <label class="form-label">分析狀態</label>
                            <input name="f_status" class="form-control" readonly>
                        </div>
                        <div class="form-inline mb-3">
                            <label class="form-label">備註</label>
                            <textarea name="f_notes" class="form-control" rows="3" readonly></textarea>
                        </div>
                    </div>
                </div>

                <div class="section-toggle styled-toggle" data-bs-toggle="collapse" data-bs-target="#imageCollapse"
                role="button" aria-expanded="true" aria-controls="imageCollapse">
                    <h5 class="toggle-title">
                        <i class="fas fa-chevron-down me-2 rotate-icon" data-target="#imageCollapse"></i> <%= t("record.ori_picture") %>
                    </h5>
                </div>

                <div id="imageCollapse" class="collapse show">
                    <div class="image-upload">
                        <% const parts = [
                        ["1", t("parts.upper_gum")],
                        ["2", t("parts.palate")],
                        ["3", t("parts.right_cheek")],
                        ["4", t("parts.tongue_right")],
                        ["5", t("parts.tongue_left")],
                        ["6", t("parts.left_cheek")],
                        ["7", t("parts.tongue_under")],
                        ["8", t("parts.lower_gum")]
                        ]; %>
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                        <% for (let i = 0; i < parts.length; i += 2) { %>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                            <% for (let j = i; j < i + 2 && j < parts.length; j++) {
                                const code = parts[j][0];
                                const label = parts[j][1];
                            %>
                                <div style="width: 140px; text-align: center;">
                                <img src="/static/images/<%= code %>.png"
                                    alt="<%= label %>"
                                    style="width: 100%; border-radius: 6px; margin-bottom: 5px;"
                                    id="preview_<%= code %>"
                                    name="preview_<%= code %>">
                                <div style="font-size: 14px; font-weight: 500;"><%= label %></div>
                                <input type="file" name="pic<%= code %>" id="upload_<%= code %>" hidden>
                                <input type="text" name="pic<%= code %>_2" id="upload2_<%= code %>" hidden>
                                <button type="button" id="SelectBtn_<%= code %>"> <%= t("record.upload") %> </button>
                                </div>
                            <% } %>
                            </div>
                        <% } %>
                        </div>
                    </div>
                </div>

                <!-- 診斷內容 -->
                <div class="section-toggle styled-toggle" data-bs-toggle="collapse" data-bs-target="#visualResultCollapse"
                    role="button" aria-expanded="true" aria-controls="visualResultCollapse">
                    <h5 class="toggle-title">
                        <i class="fas fa-chevron-down me-2 rotate-icon" data-target="#visualResultCollapse"></i> <%= t("record.res_picture") %>
                    </h5>
                </div>

                <div id="visualResultCollapse" class="collapse show">
                    <div class="image-upload">
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <% for (let i = 0; i < parts.length; i += 2) { %>
                            <div style="display: flex; justify-content: center; gap: 20px;">
                                <% for (let j = i; j < i + 2 && j < parts.length; j++) {
                                    const code = parts[j][0];
                                    const label = parts[j][1];
                                %>
                                <div style="width: 140px; text-align: center;">
                                    <img src="/static/images/<%= code %>.png"
                                        alt="<%= label %>"
                                        style="width: 100%; border-radius: 6px; margin-bottom: 5px;"
                                        id="preview_result_<%= code %>">
                                    <div style="font-size: 14px; font-weight: 500;"><%= label %></div>
                                </div>
                                <% } %>
                            </div>
                            <% } %>
                        </div>
                    </div>
                </div>

                <div class="section-toggle styled-toggle" data-bs-toggle="collapse" data-bs-target="#descResultCollapse"
                    role="button" aria-expanded="true" aria-controls="descResultCollapse">
                    <h5 class="toggle-title">
                        <i class="fas fa-chevron-down me-2 rotate-icon" data-target="#descResultCollapse"></i> <%= t("record.diag_report") %>
                    </h5>
                </div>

                <div id="descResultCollapse" class="collapse show">
                    <div class="modal-body">
                        <div class="mb-3 text-center"> 
                            <label class="form-label"> <%= t("record.category_result") %> </label>
                            <div class="risk-level">
                                <span class="risk-light green" data-level="low"></span>
                                <span class="risk-light yellow" data-level="medium"></span>
                                <span class="risk-light red active" data-level="high"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"> <%= t("record.diag_explain") %> </label>
                            <textarea name="results" class="form-control"></textarea>
                        </div>
                        <br>
                        <div class="mb-3">
                            <label class="form-label"> <%= t("record.suggestion") %> </label>
                            <textarea name="auto_suggestion" class="form-control"></textarea>
                        </div>
                        <br>
                        <div>
                            <p class="text-start"> <%= t("suggestion") %> </p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"> <%= t("record.doctor_suggestion") %> </label>
                            <textarea name="doctor_suggestion" class="form-control"></textarea>
                        </div>
                        <br>
                    </div>
                </div>

                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button type="button" class="btn btn-primary"> 審核確認 </button>
                </div>
            </form>
        </div>
    </div>
</div>